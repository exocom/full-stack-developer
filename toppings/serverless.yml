service: toppings

plugins:
  - serverless-webpack
  - "@kalarrs/serverless-project-utils"

provider:
  name: aws
  runtime: nodejs8.10
  profile: ${file(../serverless.yml):provider.profile}
  region: ${file(../serverless.yml):provider.region}
  stage: ${file(../serverless.yml):provider.stage}
  memorySize: 128
  environment:
    TOPPING_COLLECTION: ${file(../serverless.yml):provider.environment.TOPPING_COLLECTION}
    TOPPINGS_S3_BUCKET: ${cf:AttachmentsBucket}}

  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "s3:PutObject"
      Resource:
        - Ref: ToppingsBucket
    - Effect: "Allow"
      Action:
        - "s3:GetObject"
        - "s3:PutBucketNotification"
      Resource:
        - Ref: ToppingsBucket

functions:
  handler:
    handler: src/handler.createTopping
    #    layers:
    #      #  If the layer is defined in this yaml:
    #      #  Ref name is generated by TitleCasing the layer name & appending LambdaLayer
    #      - {Ref: Node_modulesLambdaLayer}
    #
    #      #  If the layer is NOT defined in this yaml:
    #      #  Use arn with name and version
    #      - arn:aws:lambda:us-west-2:123456789012:layer:node_modules:1
    #      - arn:aws:lambda:us-west-2:123456789012:layer:ffmpeg:1

    events:
      - http:
          path: toppings
          method: post

resources:  # CloudFormation template syntax
  Resources:
    ToppingsBucket:
      Type: AWS::S3::Bucket

  Outputs:
    AttachmentsBucketName:
      Value:
        Ref: AttachmentsBucket
      Export:
        Name: ${self:service}:${file(../serverless.yml):provider.stage}:AttachmentsBucket

custom:
  localDevPort: 5000
  webpack:
    webpackConfig: "webpack.config.js"
    includeModules: true
